import pandas as pd
import os
from pathlib import Path

# Function to merge Excel files from a folder
def merge_excel_files(folder_path, output_file):
    all_data = []
    first_file = True
    
    # Iterate through all Excel files in the folder
    for file in Path(folder_path).glob('*.xlsx'):
        print(f"Processing {file}")
        # Read all sheets from the current Excel file
        xl = pd.ExcelFile(file)
        for sheet_name in xl.sheet_names:
            # For the first tab of the first file, keep headers
            if first_file and sheet_name == xl.sheet_names[0]:
                df = pd.read_excel(file, sheet_name=sheet_name)
                first_file = False
            else:
                # Skip the header row for all other tabs/files
                df = pd.read_excel(file, sheet_name=sheet_name, header=None, skiprows=1)
                # Assign column names from the first tab
                df.columns = all_data[0].columns
            
            all_data.append(df)
    
    # Concatenate all dataframes
    merged_df = pd.concat(all_data, ignore_index=True)
    # Save to CSV (more efficient for huge files than Excel)
    merged_df.to_csv(output_file, index=False)
    print(f"Saved merged file to {output_file}")
    return merged_df

# Paths to your folders and files (update these accordingly)
folder1_path = 'path/to/folder1'
folder2_path = 'path/to/folder2'
user_file_path = 'path/to/user_file.xlsx'
output_folder1 = 'merged_folder1.csv'
output_folder2 = 'merged_folder2.csv'
final_output = 'final_output.csv'

# Step 1: Merge files from both folders
print("Merging files from Folder 1...")
df1 = merge_excel_files(folder1_path, output_folder1)
print("Merging files from Folder 2...")
df2 = merge_excel_files(folder2_path, output_folder2)

# Step 2: Load user info file
print("Loading user info file...")
df3 = pd.read_excel(user_file_path)

# Step 3: Join the dataframes
# Assuming key1 is in df1, key2 is in df2, and 'user' is the username column
# Adjust column names based on your actual data
print("Performing join operation...")
# Merge df1 and df2 on key1 = key2
merged_df = pd.merge(df1, df2, left_on='key1', right_on='key2', how='inner')

# Filter rows where username matches users in df3
# Assuming 'user' is the column name in all files for username
user_list = df3['user'].tolist()
final_df = merged_df[merged_df['user'].isin(user_list)]

# Step 4: Save the final result
print("Saving final output...")
final_df.to_csv(final_output, index=False)
print(f"Final output saved to {final_output}")

# Optional: Memory cleanup
del df1, df2, df3, merged_df, final_df