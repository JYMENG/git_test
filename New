do Import-Module ActiveDirectory

# Load groups from CSV/Excel
$groups = Import-Csv -Path "groups.csv"  # Columns: GroupName, Server

# Keep track of seen users
$allUsers = @()

foreach ($entry in $groups) {
    $groupName = $entry.GroupName
    $server = $entry.Server

    Write-Host "Processing group '$groupName' on server '$server'"

    try {
        $seenGroups = @{}

        function Get-GroupUsersRecursive {
            param (
                [string]$GroupName,
                [string]$Server
            )

            if ($seenGroups.ContainsKey($GroupName)) { return }
            $seenGroups[$GroupName] = $true

            $members = Get-ADGroupMember -Identity $GroupName -Server $Server -ErrorAction Stop
            foreach ($member in $members) {
                if ($member.objectClass -eq "user") {
                    $user = Get-ADUser -Identity $member.DistinguishedName -Server $Server -Properties DisplayName, EmailAddress
                    $script:allUsers += [PSCustomObject]@{
                        GroupName      = $GroupName
                        Server         = $Server
                        UserName       = $user.SamAccountName
                        DisplayName    = $user.DisplayName
                        Email          = $user.EmailAddress
                        DN             = $user.DistinguishedName
                    }
                } elseif ($member.objectClass -eq "group") {
                    Get-GroupUsersRecursive -GroupName $member.Name -Server $Server
                }
            }
        }

        Get-GroupUsersRecursive -GroupName $groupName -Server $server

    } catch {
        Write-Warning "❌ Failed to get group '$groupName' on server '$server': $_"
    }
}

# Export results
$allUsers | Export-Csv -Path "AD_Users_Recursive.csv" -NoTypeInformation
Write-Host "✅ Export Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

