import csv
import os

# Folder path containing the files
folder_path = 'path_to_folder'
file2_path = 'file2.csv'  # File containing the list of valid users
output_path = 'all_matched_records.csv'

# Step 1: Read users from file2.csv into a set
valid_users = set()
with open(file2_path, 'r') as file2:
    reader = csv.reader(file2)
    header = next(reader)  # Skip the header if present
    for row in reader:
        valid_users.add(row[0])  # Assuming 'User' is in the first column

# Step 2: Search all files in the folder for matched Record_IDs
matched_record_ids = set()
for filename in os.listdir(folder_path):
    if filename.endswith('.csv'):  # Process only CSV files
        file_path = os.path.join(folder_path, filename)
        with open(file_path, 'r') as file:
            reader = csv.reader(file)
            header = next(reader)  # Skip the header
            for row in reader:
                # Check if Manager 1 or Manager 2 matches a valid user
                if row[1] in valid_users or row[2] in valid_users:  # Manager 1 or Manager 2
                    matched_record_ids.add(row[0])  # Collect the Record_ID

# Step 3: Extract all records with matched Record_IDs across all files
all_matched_records = []
header_written = False  # To ensure we write the header only once

for filename in os.listdir(folder_path):
    if filename.endswith('.csv'):  # Process only CSV files
        file_path = os.path.join(folder_path, filename)
        with open(file_path, 'r') as file:
            reader = csv.reader(file)
            header = next(reader)  # Read the header
            if not header_written:
                all_matched_records.append(header)  # Write header once
                header_written = True
            for row in reader:
                if row[0] in matched_record_ids:  # Check if Record_ID matches
                    all_matched_records.append(row)

# Step 4: Write all matched records to a new file
with open(output_path, 'w', newline='') as output_file:
    writer = csv.writer(output_file)
    writer.writerows(all_matched_records)

print(f"All matched records written to {output_path}")