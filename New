import pdfplumber
import pandas as pd
from pathlib import Path

# --- Step 1: Load Control File ---
control_df = pd.read_excel("control.xlsx")  # Make sure this has col1 and col2

# --- Step 2: Setup ---
pdf_folder = Path("path/to/pdf/folder")  # Change this to your folder
results = []

# --- Step 3: Process PDFs ---
for pdf_file in pdf_folder.glob("*.pdf"):
    with pdfplumber.open(pdf_file) as pdf:
        for page in pdf.pages:
            tables = page.extract_tables()
            for table in tables:
                # Clean table into DataFrame
                if not table or len(table) < 2:
                    continue  # Skip empty tables
                try:
                    df = pd.DataFrame(table[1:], columns=table[0])
                except Exception:
                    continue
                df.columns = df.columns.str.strip()
                df = df.dropna(how="all")

                # Step 4: Loop over control rows
                for _, ctrl_row in control_df.iterrows():
                    col1_val = str(ctrl_row['col1']).strip()
                    col2_val = str(ctrl_row['col2']).strip()

                    # Lookup col1 row → get first 3 columns as dates
                    col1_match = df[df.iloc[:, 0].astype(str).str.strip() == col1_val]
                    if col1_match.empty:
                        continue
                    d1, d2, d3 = col1_match.iloc[0, :3].tolist()

                    # Lookup col2 row → get values from d1, d2, d3 columns
                    col2_match = df[df.iloc[:, 0].astype(str).str.strip() == col2_val]
                    if col2_match.empty:
                        continue
                    col2_row = col2_match.iloc[0]

                    for date in [d1, d2, d3]:
                        if date in df.columns:
                            value = col2_row[date]
                        else:
                            value = None
                        results.append({
                            "col1": col1_val,
                            "col2": col2_val,
                            "date": date,
                            "value": value
                        })

# --- Step 5: Save Result ---
if results:
    result_df = pd.DataFrame(results)
    result_df.to_excel("final_output.xlsx", index=False)
    print("Exported to final_output.xlsx")
else:
    print("No matches found.")