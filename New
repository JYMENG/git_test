import pandas as pd
import os

# Function to merge files in a folder
def merge_folder_files(folder_path):
    all_data = []
    
    # Iterate through each file in the folder
    for filename in os.listdir(folder_path):
        if filename.endswith('.xlsx') or filename.endswith('.xls'):
            file_path = os.path.join(folder_path, filename)
            print(f"Processing {filename}...")
            
            xl = pd.ExcelFile(file_path)
            sheet_names = xl.sheet_names
            
            # Get header from the first tab
            header_df = pd.read_excel(file_path, sheet_name=sheet_names[0], nrows=1)
            header = header_df.columns.tolist()
            
            file_data = []
            # Process each sheet
            for sheet in sheet_names:
                if 'SQL' not in sheet:
                    print(f" - Reading sheet: {sheet}")
                    # Use chunks for large files
                    if sheet == sheet_names[0]:
                        df = pd.read_excel(file_path, sheet_name=sheet)
                    else:
                        df = pd.read_excel(file_path, sheet_name=sheet, header=None, skiprows=1)
                        df.columns = header
                    file_data.append(df)
            
            # Combine tabs from this file
            if file_data:
                combined_file_df = pd.concat(file_data, ignore_index=True)
                all_data.append(combined_file_df)
    
    # Combine all files in the folder
    if all_data:
        return pd.concat(all_data, ignore_index=True)
    return None

# Paths to your two folders and user ID file
folder1_path = 'path_to_folder1'  # Replace with first folder path
folder2_path = 'path_to_folder2'  # Replace with second folder path
userid_file = 'path_to_userid_file.csv'  # Replace with user ID file path

# Step 1: Merge files in each folder
print("Merging files in Folder 1...")
df_folder1 = merge_folder_files(folder1_path)
print("Merging files in Folder 2...")
df_folder2 = merge_folder_files(folder2_path)

# Step 2: Join the two merged datasets
if df_folder1 is not None and df_folder2 is not None:
    print("Joining the two datasets...")
    combined_df = pd.concat([df_folder1, df_folder2], ignore_index=True)
elif df_folder1 is not None:
    combined_df = df_folder1
elif df_folder2 is not None:
    combined_df = df_folder2
else:
    raise ValueError("No data found in either folder.")

# Step 3: Filter by user IDs
print("Filtering by user IDs...")
user_ids = pd.read_csv(userid_file)  # Adjust if it's Excel: pd.read_excel()
user_id_list = user_ids['userid'].tolist()  # Adjust column name if different

# Filter the combined dataframe
filtered_df = combined_df[combined_df['userid'].isin(user_id_list)]

# Save the result
output_file = 'final_filtered_output.xlsx'
filtered_df.to_excel(output_file, index=False)
print(f"Final filtered data saved to {output_file}")