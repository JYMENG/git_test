Option Explicit

Sub ImportPDFFiles()
    Dim wsList As Worksheet, wsData As Worksheet
    Dim pdfFolder As String
    Dim fileName As String
    Dim lastRow As Long
    Dim i As Long
    
    ' Define worksheets
    Set wsList = ThisWorkbook.Sheets("PDF_List")  ' Sheet for the list of PDFs
    Set wsData = ThisWorkbook.Sheets("PDF_Data")  ' Sheet for imported PDF data
    
    ' Clear old PDF list (Column A in "PDF_List")
    wsList.Range("A:A").Clear
    
    ' Get folder path from named cell
    On Error Resume Next
    pdfFolder = ThisWorkbook.Names("PDF_Folder_Path").RefersToRange.Value
    On Error GoTo 0
    
    ' Validate folder path
    If pdfFolder = "" Or Dir(pdfFolder, vbDirectory) = "" Then
        MsgBox "Invalid or missing folder path! Check the named cell 'PDF_Folder_Path'.", vbExclamation
        Exit Sub
    End If
    
    ' Ensure folder path ends with "\"
    If Right(pdfFolder, 1) <> "\" Then pdfFolder = pdfFolder & "\"
    
    ' Debug message
    Debug.Print "Scanning folder: " & pdfFolder
    
    ' Get first PDF file
    fileName = Dir(pdfFolder & "*.pdf")
    
    ' Check if folder contains PDFs
    If fileName = "" Then
        MsgBox "No PDF files found in the folder!", vbExclamation
        Exit Sub
    End If
    
    ' List PDF files in "PDF_List"
    i = 1
    Do While fileName <> ""
        wsList.Cells(i, 1).Value = pdfFolder & fileName ' Store full path in Column A
        Debug.Print "Found file: " & fileName
        i = i + 1
        fileName = Dir
    Loop
    
    ' Get last row
    lastRow = wsList.Cells(Rows.Count, 1).End(xlUp).Row
    
    ' Clear old imported data in "PDF_Data" before importing new PDFs
    wsData.Cells.Clear
    
    ' Process each PDF
    For i = 1 To lastRow
        Debug.Print "Importing: " & wsList.Cells(i, 1).Value
        ImportPDF wsList.Cells(i, 1).Value, wsData
    Next i
    
    ' Mark completion
    wsList.Cells(lastRow + 2, 1).Value = "FINISHED"
    Debug.Print "Processing complete!"
    
    MsgBox "All PDF files have been processed!", vbInformation
End Sub

Sub ImportPDF(pdfPath As String, wsData As Worksheet)
    Dim queryName As String
    Dim dataRange As Range
    
    ' Debug message
    Debug.Print "Reading PDF: " & pdfPath
    
    ' Remove existing query if it exists
    On Error Resume Next
    queryName = "PDFImportQuery"
    ThisWorkbook.Queries(queryName).Delete
    On Error GoTo 0
    
    ' Ensure we start in cell A1 in "PDF_Data"
    Set dataRange = wsData.Range("A1")
    
    ' Use Power Query to import PDF
    With wsData.ListObjects.Add(SourceType:=0, Source:= _
        "OLEDB;Provider=Microsoft.Mashup.OleDb.1;Data Source=$Workbook$;Location=" & pdfPath, _
        Destination:=dataRange)
        .Name = "PDFImportTable"
    End With
    
    ' Debug message
    Debug.Print "PDF imported: " & pdfPath
    
    ' Call processing function
    ProcessPDFData wsData
End Sub

Sub ProcessPDFData(wsData As Worksheet)
    ' Debug message
    Debug.Print "Processing imported data..."
    
    ' Example: Sort data in ascending order (modify as needed)
    On Error Resume Next
    wsData.Range("A1").Sort Key1:=wsData.Range("A2"), Order1:=xlAscending, Header:=xlYes
    On Error GoTo 0
    
    ' Debug message
    Debug.Print "Data processing complete."
End Sub