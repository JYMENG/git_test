import csv

# File paths
file1_path = 'file1.csv'  # Contains ID, PM
file2_path = 'file2.csv'  # Contains Name, Path
output_path = 'unique_records.csv'

# Step 1: Read File 2 into a dictionary (keyed by lowercase Name)
file2_data = {}
with open(file2_path, 'r') as file2:
    reader = csv.reader(file2, delimiter=',')  # Adjust delimiter if needed
    header2 = next(reader)  # Skip the header
    name_index = header2.index('Name')  # Index of the Name column
    path_index = header2.index('Path')  # Index of the Path column

    for row in reader:
        name_lower = row[name_index].strip().lower()  # Normalize Name to lowercase
        file2_data[name_lower] = row[path_index]  # Map Name to Path

# Step 2: Process File 1 to find unique records and join with File 2
unique_records = set()  # Track unique (ID, PM) combinations
output_rows = []  # Store the resulting rows

with open(file1_path, 'r') as file1:
    reader = csv.reader(file1, delimiter=',')  # Adjust delimiter if needed
    header1 = next(reader)  # Read the header row
    id_index = header1.index('ID')  # Index of the ID column
    pm_index = header1.index('PM')  # Index of the PM column

    # Prepare the output header
    output_header = header1 + ['Path']  # Add the Path column to the output
    output_rows.append(output_header)

    for row in reader:
        id_value = row[id_index].strip()
        pm_lower = row[pm_index].strip().lower()  # Normalize PM to lowercase
        unique_key = (id_value, pm_lower)  # Combine ID and PM for uniqueness

        # Check uniqueness and join condition
        if unique_key not in unique_records and pm_lower in file2_data:
            unique_records.add(unique_key)  # Mark this (ID, PM) as seen
            joined_row = row + [file2_data[pm_lower]]  # Add Path from File 2
            output_rows.append(joined_row)

# Step 3: Write the unique joined records to the output file
with open(output_path, 'w', newline='') as output_file:
    writer = csv.writer(output_file, delimiter=',')  # Adjust delimiter if needed
    writer.writerows(output_rows)

print(f"Unique joined records written to {output_path}")