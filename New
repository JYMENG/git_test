Import-Module ActiveDirectory
Import-Module ImportExcel

# Load Excel group list
$groups = Import-Excel -Path "groups.xlsx"

$allUsers = @()

foreach ($row in $groups) {
    $groupName = $row.GroupName
    $server = $row.Server

    if (-not $groupName -or -not $server) {
        Write-Warning "‚ö†Ô∏è Skipping row with missing GroupName or Server."
        continue
    }

    Write-Host "üîç Processing group '$groupName' on server '$server'"

    $seenGroups = @{}

    function Get-GroupUsersRecursive {
        param (
            [string]$GroupName,
            [string]$Server
        )

        if ($seenGroups.ContainsKey($GroupName)) { return }
        $seenGroups[$GroupName] = $true

        try {
            $members = Get-ADGroupMember -Identity $GroupName -Server $Server -ErrorAction Stop
        } catch {
            Write-Warning "‚ùå Cannot get members of $GroupName: $_"
            return
        }

        foreach ($member in $members) {
            $entry = [PSCustomObject]@{
                Group             = $GroupName
                Server            = $Server
                Name              = $member.Name
                ObjectClass       = $member.ObjectClass
                SamAccountName    = ''
                Email             = ''
                DistinguishedName = $member.DistinguishedName
                Note              = ''
            }

            if ($member.objectClass -eq 'user') {
                try {
                    $user = Get-ADUser -Identity $member.DistinguishedName -Server $Server -Properties EmailAddress
                    $entry.SamAccountName = $user.SamAccountName
                    $entry.Email = $user.EmailAddress
                } catch {
                    $entry.Note = "‚ö†Ô∏è Cannot read user info"
                }
            }
            elseif ($member.objectClass -eq 'group') {
                # recurse
                Get-GroupUsersRecursive -GroupName $member.Name -Server $Server
                continue
            }
            else {
                # ForeignSecurityPrincipal, computer, etc.
                $entry.Note = "Non-user/group object (e.g., $($member.objectClass))"
            }

            $script:allUsers += $entry
        }
    }

    Get-GroupUsersRecursive -GroupName $groupName -Server $server
}

# Export to CSV
$allUsers | Export-Csv -Path "AD_Users_Recursive_WithNotes.csv" -NoTypeInformation
Write-Host "‚úÖ Exported results to 'AD_Users_Recursive_WithNotes.csv'"