import pandas as pd
from sqlalchemy import create_engine
from datetime import datetime, timedelta

# === CONFIGURATION ===
table_names = ['table1', 'table2', 'table3']  # Replace with your actual table names
date_column = 'date_column'  # Replace with your actual date column name
output_file = 'weekly_data.xlsx'

# SQLAlchemy connection string example (adjust for your DB):
# For SQLite: 'sqlite:///your_database.db'
# For PostgreSQL: 'postgresql://user:password@localhost/dbname'
engine = create_engine('sqlite:///your_database.db')

# Date filter: last 7 days
end_date = datetime.today()
start_date = end_date - timedelta(days=7)

# === FETCH & WRITE DATA ===
with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
    for table in table_names:
        query = f"""
            SELECT * FROM {table}
            WHERE {date_column} BETWEEN '{start_date.date()}' AND '{end_date.date()}'
        """
        try:
            df = pd.read_sql_query(query, con=engine)
            df.to_excel(writer, sheet_name=table[:31], index=False)  # Sheet names max 31 chars
        except Exception as e:
            print(f"Error processing {table}: {e}")