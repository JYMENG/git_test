Sub ProcessData()
    Dim wsControl As Worksheet, wsTab2 As Worksheet, wsOutput As Worksheet
    Set wsControl = ThisWorkbook.Sheets("Control")
    Set wsTab2 = ThisWorkbook.Sheets("Tab2")
    Set wsOutput = ThisWorkbook.Sheets("Output")
    
    Dim lastRowControl As Long
    lastRowControl = wsControl.Cells(wsControl.Rows.Count, 1).End(xlUp).Row
    
    Dim outputRow As Long
    outputRow = 2 ' Start writing to row 2 in Output sheet
    
    Dim i As Long
    For i = 2 To lastRowControl
        Dim key1 As String, key2 As String
        key1 = Trim(wsControl.Cells(i, 1).Value)
        key2 = Trim(wsControl.Cells(i, 2).Value)

        If key1 = "" Or key2 = "" Then GoTo SkipRow ' Skip empty keys

        ' === Step 1: Find first non-empty row in Tab2 where col1 = key1
        Dim matchRow1 As Long: matchRow1 = 0
        Dim rowTab2 As Long
        For rowTab2 = 2 To wsTab2.Rows.Count
            If Trim(wsTab2.Cells(rowTab2, 1).Value) = key1 Then
                matchRow1 = rowTab2
                Exit For
            End If
            If Application.CountA(wsTab2.Rows(rowTab2)) = 0 Then Exit For ' Stop at empty row
        Next rowTab2

        If matchRow1 = 0 Then GoTo SkipRow

        ' === Step 2: Find first non-empty cell with "/" in the matchRow1
        Dim colWithSlash As Long: colWithSlash = 0
        Dim header As String
        Dim maxCol As Long
        maxCol = wsTab2.Cells(1, wsTab2.Columns.Count).End(xlToLeft).Column

        Dim colTab2 As Long
        For colTab2 = 2 To maxCol ' Skip col 1 (ID column)
            Dim cellVal As Variant
            cellVal = wsTab2.Cells(matchRow1, colTab2).Value
            If Not IsEmpty(cellVal) And InStr(cellVal, "/") > 0 Then
                colWithSlash = colTab2
                header = wsTab2.Cells(1, colTab2).Value
                Exit For
            End If
        Next colTab2

        If colWithSlash = 0 Or header = "" Then GoTo SkipRow

        ' === Step 3: Find row where col1 = key2 (lookup ID)
        Dim matchRow2 As Long: matchRow2 = 0
        For rowTab2 = 2 To wsTab2.Rows.Count
            If Trim(wsTab2.Cells(rowTab2, 1).Value) = key2 Then
                matchRow2 = rowTab2
                Exit For
            End If
            If Application.CountA(wsTab2.Rows(rowTab2)) = 0 Then Exit For ' Stop at empty row
        Next rowTab2

        If matchRow2 = 0 Then GoTo SkipRow

        ' === Step 4: Get value at [matchRow2, column with header]
        Dim val1 As Variant
        val1 = wsTab2.Cells(matchRow2, colWithSlash).Value

        ' === Step 5: Output result
        wsOutput.Cells(outputRow, 1).Value = key1
        wsOutput.Cells(outputRow, 2).Value = key2
        wsOutput.Cells(outputRow, 3).Value = header
        wsOutput.Cells(outputRow, 4).Value = val1
        outputRow = outputRow + 1

SkipRow:
        ' Continue loop
    Next i

    MsgBox "Done!"
End Sub