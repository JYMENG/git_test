import pandas as pd
import os
import time

def process_excel_folder(folder_path):
    """Processes all Excel files in a folder, excluding 'SQL' tabs, with debug info, only first tab header."""
    print(f"Starting to process folder: {folder_path}")
    all_data = []
    file_count = 0
    sheet_count = 0
    try:
        for filename in os.listdir(folder_path):
            if filename.endswith(('.xlsx', '.xls')):
                file_count += 1
                file_path = os.path.join(folder_path, filename)
                print(f"  Processing file: {filename}")
                try:
                    xls = pd.ExcelFile(file_path)
                    first_sheet = True #track if first sheet.
                    for sheet_name in xls.sheet_names:
                        if 'SQL' not in sheet_name.upper():
                            sheet_count += 1
                            print(f"    Reading sheet: {sheet_name}")
                            if first_sheet:
                                df = pd.read_excel(xls, sheet_name=sheet_name) #read headers.
                                first_sheet = False #no longer first sheet.
                            else:
                                df = pd.read_excel(xls, sheet_name=sheet_name, header=None) #no headers.
                            all_data.append(df)
                            print(f"      Sheet {sheet_name} read successfully. Shape: {df.shape}")
                        else:
                            print(f"    Skipping sheet: {sheet_name} (contains 'SQL')")
                except Exception as e:
                    print(f"  Error processing {filename}: {e}")
        print(f"Folder {folder_path} processed. {file_count} files, {sheet_count} sheets processed.")
        if all_data:
            print("  Concatenating sheets...")
            combined_df = pd.concat(all_data, ignore_index=True)
            print(f"  Combined data shape: {combined_df.shape}")
            return combined_df
        else:
            print(f"  No valid sheets found in {folder_path}.")
            return None
    except Exception as overall_error:
        print(f"Error processing folder {folder_path}: {overall_error}")
        return None