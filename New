import pandas as pd

# Define the key columns and the specified status
key_columns = ['ID', 'Step']
specified_status = 'Completed'

# Read the input CSV file with '!' as the delimiter
input_file = 'input_data.csv'  # Replace with your CSV file path
df = pd.read_csv(input_file, sep='!')

# Validate the input data: Check for key combinations with more than one row of the specified status
validation = df[df['Status'] == specified_status].groupby(key_columns).size().reset_index(name='Count')
invalid_records = validation[validation['Count'] != 1]

if not invalid_records.empty:
    print("Validation failed: The following key combinations have more than one row with the specified status:")
    print(invalid_records)
else:
    print("Validation passed: Each key combination has only one row with the specified status.")

    # Filter records where only one step exists with the specified status
    filtered_df = df[df['Status'] == specified_status].groupby(key_columns).filter(lambda x: len(x) == 1)

    # Delete the validated records from the input DataFrame
    updated_df = df[~df.index.isin(filtered_df.index)]

    # Save the updated DataFrame to a new CSV file
    output_file = 'updated_input_data.csv'  # Replace with your desired output file path
    updated_df.to_csv(output_file, sep='!', index=False)

    # Display the updated DataFrame (optional)
    print("Updated DataFrame (after deleting validated records):")
    print(updated_df)