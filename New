function Get-AllADGroupMembers {
    param (
        [Parameter(Mandatory=$true)]
        [string]$GroupName
    )

    # Keep track of visited groups to avoid infinite loops
    $visitedGroups = @{}

    function Get-MembersRecursive {
        param (
            [string]$Group
        )

        # Avoid revisiting groups
        if ($visitedGroups.ContainsKey($Group)) {
            return
        } else {
            $visitedGroups[$Group] = $true
        }

        try {
            $members = Get-ADGroupMember -Identity $Group -ErrorAction Stop
        } catch {
            Write-Warning "Cannot access group $Group: $_"
            return
        }

        foreach ($member in $members) {
            if ($member.objectClass -eq 'user' -or $member.objectClass -eq 'foreignSecurityPrincipal') {
                $member
            } elseif ($member.objectClass -eq 'group') {
                Get-MembersRecursive -Group $member.DistinguishedName
            }
        }
    }

    Get-MembersRecursive -Group $GroupName
}