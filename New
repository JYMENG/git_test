# Define your input Excel or CSV path
$inputFile = "C:\Path\To\Your\File.xlsx"
$groups = Import-Excel -Path $inputFile  # Use Import-Csv if needed

# Recursive function to walk nested group members
function Get-ADGroupRecursiveMembers {
    param (
        [string]$GroupDN,
        [string]$Server,
        [System.Collections.Generic.HashSet[string]]$VisitedGroups,
        [string[]]$PathSoFar
    )

    if ($VisitedGroups.Contains($GroupDN)) {
        return
    }
    $VisitedGroups.Add($GroupDN)

    try {
        $group = Get-ADGroup -Identity $GroupDN -Server $Server -Properties Members
    } catch {
        Write-Warning "Group not found or inaccessible: $GroupDN"
        return
    }

    foreach ($memberDN in $group.Members) {
        try {
            $member = Get-ADObject -Identity $memberDN -Server $Server -Properties objectClass
            if ($member.objectClass -eq "group") {
                Get-ADGroupRecursiveMembers -GroupDN $memberDN -Server $Server -VisitedGroups $VisitedGroups -PathSoFar ($PathSoFar + $GroupDN)
            } else {
                [PSCustomObject]@{
                    GroupPath  = ($PathSoFar + $GroupDN) -join " -> "
                    MemberDN   = $memberDN
                    ObjectType = $member.objectClass
                }
            }
        } catch {
            Write-Warning "Skipping inaccessible or external member: $memberDN"
        }
    }
}

# Collect all results
$allResults = @()

foreach ($entry in $groups) {
    $groupName  = $entry.GroupName
    $serverName = $entry.ServerName

    try {
        $rootGroup = Get-ADGroup -Identity $groupName -Server $serverName
        $visited   = New-Object 'System.Collections.Generic.HashSet[string]'
        $members   = Get-ADGroupRecursiveMembers -GroupDN $rootGroup.DistinguishedName -Server $serverName -VisitedGroups $visited -PathSoFar @()
        $allResults += $members
    } catch {
        Write-Warning "Failed to process group: $groupName on $serverName"
    }
}

# Output results
$allResults | Export-Csv "C:\Path\To\AllMembers_WithPaths.csv" -NoTypeInformation