import os
import csv
from datetime import datetime

def process_files_in_folder(folder_path, output_file, key_column_index, 
                           date_column1_index, date_column2_index, 
                           start_date_str, end_date_str, 
                           date_format='%Y-%m-%d'):  
    start_date = datetime.strptime(start_date_str, date_format)
    end_date = datetime.strptime(end_date_str, date_format)

    key_to_rows = {}

    for file_name in os.listdir(folder_path):
        if file_name.endswith('.csv'):
            file_path = os.path.join(folder_path, file_name)
            with open(file_path, 'r', encoding='utf-8') as input_csv:
                reader = csv.reader(input_csv, delimiter='|')
                header = next(reader)  # Read the header row

                for row in reader:
                    key = row[key_column_index]
                    try:
                        date1 = datetime.strptime(row[date_column1_index], date_format)
                        date2 = datetime.strptime(row[date_column2_index], date_format)
                    except ValueError:
                        continue  # Skip rows with invalid date format

                    if key not in key_to_rows:
                        key_to_rows[key] = []
                    key_to_rows[key].append(row)

    with open(output_file, 'w', newline='', encoding='utf-8') as output_csv:
        writer = csv.writer(output_csv)
        writer.writerow(header)

        for key, rows in key_to_rows.items():
            date_within_range = any(
                start_date <= datetime.strptime(row[date_column1_index], date_format) <= end_date or
                start_date <= datetime.strptime(row[date_column2_index], date_format) <= end_date
                for row in rows
            )
            if date_within_range:
                writer.writerows(rows)

# Example usage
folder_path = "/path/to/your/folder"
output_file = "output.csv"
key_column_index = 0 
date_column1_index = 1
date_column2_index = 2
start_date_str = "2024-01-01"
end_date_str = "2024-12-31"
date_format = '%Y-%m-%d'

process_files_in_folder(folder_path, output_file, key_column_index, 
                       date_column1_index, date_column2_index, 
                       start_date_str, end_date_str, date_format)
