import sqlite3
import pandas as pd
import glob
import os
from tqdm import tqdm

def create_db_schema(conn):
    """Create database tables with indexes"""
    conn.executescript('''
    CREATE TABLE IF NOT EXISTS folder1_data (
        k2 TEXT,
        source_file TEXT,
        sheet_name TEXT
    );
    
    CREATE TABLE IF NOT EXISTS folder2_data (
        key1 TEXT,
        user_name TEXT,
        source_file TEXT,
        sheet_name TEXT
    );
    
    CREATE TABLE IF NOT EXISTS user_ids (
        user_id TEXT PRIMARY KEY
    );
    
    CREATE INDEX idx_folder1_k2 ON folder1_data(k2);
    CREATE INDEX idx_folder2_key1 ON folder2_data(key1);
    ''')

def load_to_sqlite(conn, folder_path, folder_type, exclude_tab='SQL', chunk_size=10000):
    """Load Excel data into SQLite in chunks"""
    for file in tqdm(glob.glob(os.path.join(folder_path, "*.xlsx")), desc=f'Processing {folder_type}'):
        xls = pd.ExcelFile(file)
        for sheet_name in xls.sheet_names:
            if 'SQL' in sheet_name:
                continue
                
            for chunk in pd.read_excel(
                file,
                sheet_name=sheet_name,
                chunksize=chunk_size,
                usecols=['k2'] if folder_type == 'folder1' else ['key1', 'user_name'],
                dtype={'k2': 'string', 'key1': 'string', 'user_name': 'string'}
            ):
                # Clean data and add source metadata
                chunk = chunk.dropna()
                chunk['source_file'] = os.path.basename(file)
                chunk['sheet_name'] = sheet_name
                
                # Insert into SQLite
                chunk.to_sql(
                    f'{folder_type}_data',
                    conn,
                    if_exists='append',
                    index=False,
                    method='multi'
                )

def main():
    # Configuration
    PATHS = {
        'folder1': '/path/to/folder1',
        'folder2': '/path/to/folder2',
        'file3': '/path/to/user_ids.xlsx',
        'output_db': 'merged_data.db'
    }

    # Set up SQLite database
    with sqlite3.connect(PATHS['output_db']) as conn:
        create_db_schema(conn)
        
        # Load Folder1 data
        load_to_sqlite(conn, PATHS['folder1'], 'folder1')
        
        # Load Folder2 data
        load_to_sqlite(conn, PATHS['folder2'], 'folder2')
        
        # Load User IDs
        pd.read_excel(PATHS['file3'], usecols=['user_id']).to_sql(
            'user_ids', conn, if_exists='replace', index=False
        )

        # Execute final query
        result = pd.read_sql('''
            SELECT f1.k2, f2.user_name
            FROM folder1_data f1
            INNER JOIN folder2_data f2 ON f1.k2 = f2.key1
            INNER JOIN user_ids u ON f2.key1 = u.user_id
            GROUP BY f1.k2, f2.user_name  -- Remove duplicates
        ''', conn)

    # Save or display results
    print("Merged results:")
    print(result.head())
    result.to_csv('final_output.csv', index=False)

if __name__ == '__main__':
    main()