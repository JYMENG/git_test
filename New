import pandas as pd
import time
import win32com.client as win32

# Step 1: Setup
excel_path = "pq_template.xlsx"
sheet_name = "TableOutput"  # Sheet where Power Query outputs cleaned data

# Step 2: Open Excel and refresh Power Query
excel = win32.gencache.EnsureDispatch('Excel.Application')
excel.Visible = False  # Set to True if you want to see it open
workbook = excel.Workbooks.Open(excel_path)

print("Refreshing Power Query...")
workbook.RefreshAll()

# Wait for queries to complete
time.sleep(2)
while excel.CalculationState != 0:
    time.sleep(1)

print("Refresh complete.")

# Step 3: Save and close
workbook.Save()
workbook.Close(False)
excel.Quit()

# Step 4: Read cleaned data and continue your logic
df = pd.read_excel(excel_path, sheet_name=sheet_name)
print(df.head())
# -> now apply your col1/col2/date/value logic on this clean df