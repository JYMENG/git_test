import pdfplumber
import pandas as pd
from pathlib import Path

# --- Step 1: Load Control File ---
control_df = pd.read_excel("control.xlsx")  # Must contain 'col1' and 'col2' columns

# --- Step 2: Setup ---
pdf_folder = Path("path/to/pdf/folder")  # <-- change this
results = []

# --- Step 3: Process PDFs ---
for pdf_file in pdf_folder.glob("*.pdf"):
    with pdfplumber.open(pdf_file) as pdf:
        for page in pdf.pages:
            tables = page.extract_tables()
            for table in tables:
                # Clean table into DataFrame
                if not table or len(table) < 2:
                    continue
                try:
                    df = pd.DataFrame(table[1:], columns=table[0])
                except Exception:
                    continue
                df.columns = df.columns.str.strip()
                df = df.dropna(how="all")

                # Step 4: Loop over control rows
                for _, ctrl_row in control_df.iterrows():
                    col1_val = str(ctrl_row['col1']).strip()
                    col2_val = str(ctrl_row['col2']).strip()

                    # Find the row where first column == col1_val
                    col1_match = df[df.iloc[:, 0].astype(str).str.strip() == col1_val]
                    if col1_match.empty:
                        continue
                    col1_row = col1_match.iloc[0]

                    # Find the first 3 column headers in that row where the value contains a "/"
                    date_cols = []
                    for col_name in df.columns[1:]:  # skip the first column (label column)
                        val = str(col1_row[col_name])
                        if '/' in val:
                            date_cols.append(col_name)
                        if len(date_cols) == 3:
                            break
                    if not date_cols:
                        continue

                    # Find the row where first column == col2_val
                    col2_match = df[df.iloc[:, 0].astype(str).str.strip() == col2_val]
                    if col2_match.empty:
                        continue
                    col2_row = col2_match.iloc[0]

                    for date_col in date_cols:
                        value = col2_row.get(date_col, None)
                        results.append({
                            "col1": col1_val,
                            "col2": col2_val,
                            "date": col1_row[date_col],  # actual date string from col1 row
                            "value": value
                        })

# --- Step 5: Save Result ---
if results:
    result_df = pd.DataFrame(results)
    result_df.to_excel("final_output.xlsx", index=False)
    print("Exported to final_output.xlsx")
else:
    print("No matches found.")